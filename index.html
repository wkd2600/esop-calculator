<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>우리사주조합 과세이연·인출 과세액 계산기</title>
  <meta name="description" content="우리사주조합 과세이연 한도 및 인출 시 근로소득 과세액을 간편 계산합니다." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    input.num { text-align:right; font-variant-numeric: tabular-nums; }
    input.num::placeholder { color:#9ca3af; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
    <div class="mx-auto max-w-6xl px-5 py-3 flex items-center justify-between">
      <h1 class="text-lg font-bold">우리사주조합 과세이연·인출 과세액 계산기 <span class="text-xs align-top text-gray-500">(Unified Beta)</span></h1>
      <a href="#how" class="text-sm text-gray-600 hover:text-gray-900">로직/주의사항</a>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-5 py-6">
    <section class="grid grid-cols-1 gap-6 md:grid-cols-2">
      <!-- 좌측: 입력 -->
      <div class="space-y-6">
        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h2 class="mb-3 text-lg font-semibold">① 기본 정보</h2>
          <div class="space-y-2">
            <label class="flex items-center justify-between gap-3">
              <span class="text-sm text-gray-700">직전연도 총급여액 (원) <span class="text-xs text-gray-500">(과세이연 한도 산정용)</span></span>
              <input id="prevYearSalary" type="text" class="num w-56 rounded-xl border px-3 py-2" placeholder="50,000,000" value="50,000,000" />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-sm text-gray-700">올해 예상 총급여액 (원) <span class="text-xs text-gray-500">(세율 시뮬레이션용)</span></span>
              <input id="currYearSalary" type="text" class="num w-56 rounded-xl border px-3 py-2" placeholder="60,000,000" value="60,000,000" />
            </label>
            <p class="text-xs text-gray-500 leading-5">※ 총급여액의 의미: 급여명세서의 <strong>총지급액</strong>을 말하며, <strong>당기에 지급받은 성과급</strong>도 포함합니다. (세율 시뮬레이션을 위한 근사치로 사용)</p>
          </div>
        </div>

        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h2 class="mb-3 text-lg font-semibold">② 취득 단가 및 주식 수</h2>
          <div class="space-y-2">
            <label class="flex items-center justify-between gap-3">
              <span class="text-sm text-gray-700">실지취득단가 (원/주)</span>
              <input id="actualUnit" type="text" class="num w-56 rounded-xl border px-3 py-2" placeholder="10,000" value="10,000" />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-sm text-gray-700">취득시 시가 (원/주)</span>
              <input id="fmvAtBuy" type="text" class="num w-56 rounded-xl border px-3 py-2" placeholder="10,000" value="10,000" />
            </label>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <label class="flex items-center justify-between gap-3">
                <span class="text-sm text-gray-700">회사 무상출연분 (주)</span>
                <input id="compFreeShares" type="text" class="num w-40 rounded-xl border px-3 py-2" placeholder="0" value="0" />
              </label>
              <label class="flex items-center justify-between gap-3">
                <span class="text-sm text-gray-700">직원 출연분 (주)</span>
                <input id="employeeContribShares" type="text" class="num w-40 rounded-xl border px-3 py-2" placeholder="0" value="0" />
              </label>
            </div>
          </div>
        </div>

        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h2 class="mb-3 text-lg font-semibold">③ 인출 정보</h2>
          <div class="space-y-2">
            <label class="flex items-center justify-between gap-3">
              <span class="text-sm text-gray-700">인출 시 시가 (원/주)</span>
              <input id="fmvAtWithdraw" type="text" class="num w-56 rounded-xl border px-3 py-2" placeholder="20,000" value="20,000" />
            </label>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <label class="flex items-center justify-between gap-3">
                <span class="text-sm text-gray-700">인출할 회사 무상출연분 (주)</span>
                <input id="withdrawCompFree" type="text" class="num w-40 rounded-xl border px-3 py-2" placeholder="0" value="0" />
              </label>
              <label class="flex items-center justify-between gap-3">
                <span class="text-sm text-gray-700">인출할 직원 출연분 (주)</span>
                <input id="withdrawEmployeeContrib" type="text" class="num w-40 rounded-xl border px-3 py-2" placeholder="0" value="0" />
              </label>
            </div>
          </div>
        </div>

        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h2 class="mb-3 text-lg font-semibold">④ 공제(근사) 설정</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
            <label class="flex items-center justify-between gap-3">
              <span class="text-gray-700">기본공제 인원(본인 포함)</span>
              <input id="basicDeductCount" type="text" class="num w-32 rounded-xl border px-3 py-2" value="1" />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-gray-700">국민연금율(근로자부담, %)</span>
              <input id="rateNP" type="text" class="num w-32 rounded-xl border px-3 py-2" value="4.5" />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-gray-700">건강보험율(근로자부담, %)</span>
              <input id="rateHI" type="text" class="num w-32 rounded-xl border px-3 py-2" value="3.5" />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-gray-700">장기요양(건보의 %, 근로자)</span>
              <input id="rateLTC" type="text" class="num w-32 rounded-xl border px-3 py-2" value="12.8" />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-gray-700">고용보험율(근로자부담, %)</span>
              <input id="rateEI" type="text" class="num w-32 rounded-xl border px-3 py-2" value="0.9" />
            </label>
          </div>
          <p class="mt-2 text-xs text-gray-500">※ 위 비율은 <strong>추정치</strong>로, 실제 연도별 고시와 사업장 유형에 따라 달라질 수 있습니다. 필요 시 숫자를 조정하세요.</p>
        </div>

        <div class="rounded-2xl border bg-white p-5 shadow-sm flex items-center justify-between gap-3">
          <button id="resetBtn" class="rounded-xl border px-4 py-2 text-sm hover:bg-gray-50">입력 초기화</button>
          <div class="space-x-2">
            <button id="copyUrlBtn" class="rounded-xl border px-4 py-2 text-sm hover:bg-gray-50">현재 입력 공유 링크 복사</button>
            <button id="downloadBtn" class="rounded-xl border px-4 py-2 text-sm hover:bg-gray-50">결과 CSV 다운로드</button>
          </div>
        </div>
      </div>

      <!-- 우측: 결과 -->
      <div class="space-y-6">
        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h2 class="mb-3 text-lg font-semibold">⑤ 결과 요약</h2>
          <div class="grid grid-cols-1 gap-3 sm:grid-cols-2" id="cardsA"></div>
        </div>

        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h3 class="mb-2 font-semibold">A. 회사 무상출연분 <span class="text-gray-500">한도초과 계산</span></h3>
          <div id="overlimitBox" class="text-sm text-gray-800"></div>
        </div>

        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h3 class="mb-2 font-semibold">B. 인출 시 근로소득 <span class="text-gray-500">합산 금액</span></h3>
          <div id="withdrawBox" class="text-sm text-gray-800"></div>
        </div>

        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h3 class="mb-2 font-semibold">C. 세율 구간 & 추가세금 시뮬레이션(근사)</h3>
          <div id="taxbox" class="text-sm text-gray-800"></div>
        </div>

        <div id="detail" class="rounded-2xl border bg-white p-5 shadow-sm text-sm leading-6 text-gray-800"></div>
      </div>
    </section>

    <section id="how" class="mt-8 rounded-2xl border bg-white p-5 shadow-sm">
      <h3 class="mb-2 text-base font-semibold">계산 로직(요지) & 주의사항</h3>
      <ul class="list-disc pl-5 text-sm text-gray-700 space-y-1">
        <li>과세이연 한도 금액 = <strong>max(직전연도 총급여액×20%, 5,000,000원)</strong></li>
        <li>매입가액(근로소득 기준단가) = <strong>max(실지취득단가, 취득시 시가×70%)</strong></li>
        <li>회사 무상출연분: 한도 내 물량은 <strong>인출 시 근로소득 과세</strong>, 한도 초과분은 <strong>배정 시 근로소득 과세</strong></li>
        <li>직원 출연분: 전량 <strong>인출 시 근로소득 과세</strong></li>
        <li>인출 시 근로소득 합산액 = (과세인출주식 수) × <strong>min(매입가액, 인출시 시가)</strong></li>
        <li>세율 시뮬레이션은 <strong>근로소득공제·기본공제·4대보험(추정)</strong>을 반영한 <strong>과세표준 근사치</strong>를 이용합니다.</li>
      </ul>
      <p class="mt-3 text-xs text-gray-500">※ 실제 신고 시에는 공제항목·세액공제·연금보험료 한도·급여 외 소득 합산 등에 따라 결과가 달라질 수 있습니다. 본 계산기는 <strong>참고용</strong>입니다.</p>
    </section>
  </main>

  <footer class="mt-10 border-t">
    <div class="mx-auto max-w-6xl px-5 py-6 text-xs text-gray-500">© 2025 우리사주 간이 계산기 (Unified Beta). 모든 책임은 사용자에게 있으며, 본 도구는 참고용입니다.</div>
  </footer>

  <script>
    const $ = (id) => document.getElementById(id);
    const toNumber = (str) => {
      if (typeof str !== 'string') return Number(str) || 0;
      const cleaned = str.replace(/[^\d.-]/g, '');
      const n = parseFloat(cleaned);
      return Number.isFinite(n) ? n : 0;
    };
    const fmt = (n) => Number.isFinite(n) ? n.toLocaleString('ko-KR') : '';

    // 모든 입력에 천단위 콤마 마스크 적용
    const allFieldIds = [
      'prevYearSalary','currYearSalary','actualUnit','fmvAtBuy','compFreeShares','employeeContribShares','fmvAtWithdraw','withdrawCompFree','withdrawEmployeeContrib','basicDeductCount','rateNP','rateHI','rateLTC','rateEI'
    ];

    function bindMasks(){
      for (const id of allFieldIds){
        const el = $(id);
        const handler = () => {
          const val = toNumber(el.value);
          el.value = fmt(val);
          render();
        };
        el.addEventListener('input', handler);
        // 초기 포맷
        el.value = fmt(toNumber(el.value));
      }
    }

    function read(){
      const v = {};
      for (const id of allFieldIds) v[id] = toNumber($(id).value);
      // 정수화 필요한 항목들(주식 수)
      v.compFreeShares = Math.max(0, Math.floor(v.compFreeShares));
      v.employeeContribShares = Math.max(0, Math.floor(v.employeeContribShares));
      v.withdrawCompFree = Math.max(0, Math.floor(v.withdrawCompFree));
      v.withdrawEmployeeContrib = Math.max(0, Math.floor(v.withdrawEmployeeContrib));
      // 기본공제 인원 정수화
      v.basicDeductCount = Math.max(0, Math.floor(v.basicDeductCount));
      return v;
    }

    // 근로소득공제(간편 근사식)
    function earnedIncomeDeduction(gross){
      const x = Math.max(0, gross);
      if (x <= 12_000_000) return x*0.7;
      if (x <= 46_000_000) return 3_600_000 + (x-12_000_000)*0.4;
      if (x <= 88_000_000) return 7_500_000 + (x-46_000_000)*0.15;
      if (x <= 150_000_000) return 13_500_000 + (x-88_000_000)*0.05;
      return 16_000_000 + (x-150_000_000)*0.02;
    }

    // 4대보험(근로자부담) 추정
    function socialInsurance(gross, rateNP, rateHI, rateLTC, rateEI){
      const np = gross * (rateNP/100);
      const hi = gross * (rateHI/100);
      const ltc = hi * (rateLTC/100);
      const ei = gross * (rateEI/100);
      return { np, hi, ltc, ei, total: np+hi+ltc+ei };
    }

    function compute(){
      const v = read();

      // 한도 및 단가
      const deferralLimitAmt = Math.max(v.prevYearSalary * 0.20, 5_000_000);
      const buyBasis = Math.max(v.actualUnit, Math.floor(v.fmvAtBuy * 0.7));
      const limitShares = buyBasis > 0 ? Math.floor(deferralLimitAmt / buyBasis) : 0;

      const compWithinLimit = Math.min(v.compFreeShares, limitShares);
      const compOverLimit   = Math.max(v.compFreeShares - compWithinLimit, 0);
      const overlimitEarnedIncomeAtAllocation = compOverLimit * buyBasis; // 배정시 과세(참고)

      // 인출 과세
      const taxableWithdrawFromComp = Math.min(v.withdrawCompFree, compWithinLimit);
      const taxableWithdrawFromEmployee = Math.min(v.withdrawEmployeeContrib, v.employeeContribShares);
      const taxableWithdrawShares = taxableWithdrawFromComp + taxableWithdrawFromEmployee;
      const taxableUnit = Math.min(buyBasis, v.fmvAtWithdraw);
      const earnedIncomeAtWithdraw = taxableWithdrawShares * taxableUnit;

      // 과세표준 근사 및 세율
      const eid = earnedIncomeDeduction(v.currYearSalary);
      const si = socialInsurance(v.currYearSalary, v.rateNP, v.rateHI, v.rateLTC, v.rateEI);
      const basicDeduction = v.basicDeductCount * 1_500_000; // 1인 150만원 가정
      const approxTaxableIncome = Math.max(0, v.currYearSalary - eid - si.total - basicDeduction);

      const brackets = [
        { upTo: 12_000_000, rate: 0.06 },
        { upTo: 46_000_000, rate: 0.15 },
        { upTo: 88_000_000, rate: 0.24 },
        { upTo: 150_000_000, rate: 0.35 },
        { upTo: 300_000_000, rate: 0.38 },
        { upTo: 500_000_000, rate: 0.40 },
        { upTo: 1_000_000_000, rate: 0.42 },
        { upTo: Infinity, rate: 0.45 },
      ];
      const marginalRate = (() => {
        for (const b of brackets){ if (approxTaxableIncome <= b.upTo) return b.rate; }
        return brackets[brackets.length-1].rate;
      })();
      const marginalRateWithLocal = marginalRate * 1.10; // 지방세 10%
      const estimatedAdditionalTax = Math.round(earnedIncomeAtWithdraw * marginalRateWithLocal);

      return {
        v,
        deferralLimitAmt, buyBasis, limitShares,
        compWithinLimit, compOverLimit, overlimitEarnedIncomeAtAllocation,
        taxableWithdrawFromComp, taxableWithdrawFromEmployee, taxableWithdrawShares,
        taxableUnit, earnedIncomeAtWithdraw,
        eid, si, basicDeduction, approxTaxableIncome,
        brackets, marginalRate, marginalRateWithLocal, estimatedAdditionalTax
      };
    }

    function render(){
      const d = compute();

      // 요약 카드
      const cards = [
        {title:'과세이연 한도 금액', value:d.deferralLimitAmt, unit:'원', desc:'max(직전연도 총급여×20%, 5,000,000)'},
        {title:'매입가액(근로소득 기준단가)', value:d.buyBasis, unit:'원/주', desc:'max(실지취득단가, 시가×70%)'},
        {title:'한도 기준 주식 수', value:d.limitShares, unit:'주', desc:'과세이연 한도금액 ÷ 매입가액'},
        {title:'인출 시 과세 단가', value:d.taxableUnit, unit:'원/주', desc:'min(매입가액, 인출시 시가)'}
      ];
      $('cardsA').innerHTML = cards.map(c => `
        <div class="rounded-2xl border p-4 shadow-sm">
          <div class="text-xs text-gray-500">${c.title}</div>
          <div class="mt-1 text-2xl font-semibold">${fmt(c.value)}<span class="ml-1 text-base font-normal text-gray-500">${c.unit}</span></div>
          <div class="mt-1 text-xs text-gray-500">${c.desc}</div>
        </div>`).join('');

      // A. 한도초과 계산
      $('overlimitBox').innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="rounded-xl bg-gray-50 p-3">
            <div class="text-xs text-gray-500">회사 무상출연분(전체)</div>
            <div class="text-lg font-semibold">${fmt(d.v.compFreeShares)} <span class="text-sm">주</span></div>
          </div>
          <div class="rounded-xl bg-gray-50 p-3">
            <div class="text-xs text-gray-500">회사 무상 한도 내 주식 수</div>
            <div class="text-lg font-semibold">${fmt(d.compWithinLimit)} <span class="text-sm">주</span></div>
          </div>
          <div class="rounded-xl bg-gray-50 p-3">
            <div class="text-xs text-gray-500">회사 무상 한도 초과 주식 수</div>
            <div class="text-lg font-semibold">${fmt(d.compOverLimit)} <span class="text-sm">주</span></div>
          </div>
          <div class="rounded-xl bg-gray-50 p-3">
            <div class="text-xs text-gray-500">한도 초과분 배정 시 과세표준(참고)</div>
            <div class="text-lg font-semibold">${fmt(d.overlimitEarnedIncomeAtAllocation)} <span class="text-sm">원</span></div>
            <div class="mt-1 text-xs text-gray-500">= 한도 초과 주식 수 × 매입가액(근로소득 기준단가)</div>
          </div>
        </div>`;

      // B. 인출 합산 금액
      $('withdrawBox').innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="rounded-xl bg-gray-50 p-3">
            <div class="text-xs text-gray-500">이번 인출의 과세인출주식 수</div>
            <div class="text-lg font-semibold">${fmt(d.taxableWithdrawShares)} <span class="text-sm">주</span></div>
            <div class="mt-1 text-xs text-gray-500">회사(한도내) ${fmt(d.taxableWithdrawFromComp)}주 + 직원출연 ${fmt(d.taxableWithdrawFromEmployee)}주</div>
          </div>
          <div class="rounded-xl bg-gray-50 p-3">
            <div class="text-xs text-gray-500">인출 시 근로소득 합산 금액</div>
            <div class="text-lg font-semibold">${fmt(d.earnedIncomeAtWithdraw)} <span class="text-sm">원</span></div>
            <div class="mt-1 text-xs text-gray-500">= 과세인출주식 수 × min(매입가액, 인출시 시가)</div>
          </div>
        </div>`;

      // C. 세율 구간 및 추가세금 시뮬레이션
      const taxRows = d.brackets.map((b, i) => {
        const from = i === 0 ? 0 : d.brackets[i-1].upTo + 1;
        const to   = b.upTo === Infinity ? '이상' : `${fmt(b.upTo)}원`;
        const isMy = (d.approxTaxableIncome <= b.upTo);
        return `<tr class="${isMy ? 'bg-gray-50' : ''}">
          <td class="px-3 py-1 text-right whitespace-nowrap">${fmt(from)}원 ~ ${to}</td>
          <td class="px-3 py-1 text-right">${Math.round(b.rate*100)}%</td>
          <td class="px-3 py-1 text-right">${Math.round(b.rate*11000)/100}% (지방세 포함)</td>
        </tr>`;
      }).join('');

      $('taxbox').innerHTML = `
        <div class="grid grid-cols-1 gap-3">
          <div class="rounded-xl bg-gray-50 p-3 text-sm">
            <div class="grid grid-cols-2 gap-2">
              <div>근로소득공제(근사)</div><div class="text-right font-semibold">${fmt(d.eid)} 원</div>
              <div>4대보험(근로자부담·근사)</div><div class="text-right font-semibold">${fmt(d.si.total)} 원 <span class="text-xs text-gray-500">(국민:${fmt(d.si.np)}, 건보:${fmt(d.si.hi)}, 장기요양:${fmt(d.si.ltc)}, 고용:${fmt(d.si.ei)})</span></div>
              <div>기본공제(본인 등)</div><div class="text-right font-semibold">${fmt(d.basicDeduction)} 원</div>
              <div>과세표준(근사)</div><div class="text-right font-semibold">${fmt(d.approxTaxableIncome)} 원</div>
            </div>
          </div>
          <div class="overflow-auto">
            <table class="w-full text-xs">
              <thead class="text-gray-500">
                <tr>
                  <th class="px-3 py-1 text-right font-medium">과세표준 구간(근사)</th>
                  <th class="px-3 py-1 text-right font-medium">국세 세율</th>
                  <th class="px-3 py-1 text-right font-medium">합산 세율(국세+지방세)</th>
                </tr>
              </thead>
              <tbody>${taxRows}</tbody>
            </table>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="rounded-xl bg-gray-50 p-3">
              <div class="text-xs text-gray-500">추정 한계세율(국세)</div>
              <div class="text-lg font-semibold">${Math.round(d.marginalRate*100)}%</div>
            </div>
            <div class="rounded-xl bg-gray-50 p-3">
              <div class="text-xs text-gray-500">추정 한계세율(지방세 포함)</div>
              <div class="text-lg font-semibold">${Math.round(d.marginalRateWithLocal*10000)/100}%</div>
            </div>
            <div class="rounded-xl bg-gray-50 p-3">
              <div class="text-xs text-gray-500">예상 추가세금(근사)</div>
              <div class="text-lg font-semibold">${fmt(d.estimatedAdditionalTax)} 원</div>
            </div>
          </div>
          <div class="text-xs text-gray-500">※ 추가세금은 <strong>B. 인출 시 근로소득 합산 금액</strong>에 추정 한계세율(지방세 포함)을 적용한 값(근사)입니다.</div>
        </div>`;

      // 하단 디테일 박스
      $('detail').innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="rounded-xl bg-gray-50 p-3">
            <div class="text-xs text-gray-500">매입가액(근로소득 기준단가)</div>
            <div class="text-lg font-semibold">${fmt(d.buyBasis)} <span class="text-sm">원/주</span></div>
            <div class="mt-1 text-xs text-gray-500">= max(실지취득단가, 취득시 시가×70%)</div>
          </div>
          <div class="rounded-xl bg-gray-50 p-3">
            <div class="text-xs text-gray-500">과세이연 한도 금액</div>
            <div class="text-lg font-semibold">${fmt(d.deferralLimitAmt)} <span class="text-sm">원</span></div>
            <div class="mt-1 text-xs text-gray-500">= max(전년 총급여×20%, 5,000,000)</div>
          </div>
        </div>
        <div class="mt-3 text-xs text-gray-500">※ 본 계산기는 참고용이며, 실제 신고는 회사 규정 및 세무전문가 확인이 필요합니다.</div>
      `;
    }

    function bindActions(){
      // 공유 & 다운로드 & 초기화
      $('resetBtn').addEventListener('click', () => {
        const defaults = {
          prevYearSalary:'50,000,000', currYearSalary:'60,000,000', actualUnit:'10,000', fmvAtBuy:'10,000',
          compFreeShares:'0', employeeContribShares:'0', fmvAtWithdraw:'20,000', withdrawCompFree:'0', withdrawEmployeeContrib:'0',
          basicDeductCount:'1', rateNP:'4.5', rateHI:'3.5', rateLTC:'12.8', rateEI:'0.9'
        };
        for (const id of Object.keys(defaults)) $(id).value = defaults[id];
        bindMasks(); // 다시 포맷 적용
        render();
      });

      $('copyUrlBtn').addEventListener('click', () => {
        const params = new URLSearchParams();
        for (const id of allFieldIds) params.set(id, toNumber($(id).value));
        const url = `${location.origin}${location.pathname}?${params.toString()}`;
        navigator.clipboard.writeText(url).then(() => alert('현재 입력이 포함된 링크를 복사했습니다.'));
      });

      $('downloadBtn').addEventListener('click', () => {
        const d = compute();
        const rows = [
          ['항목','값'],
          ['직전연도 총급여액', d.v.prevYearSalary],
          ['올해 예상 총급여액', d.v.currYearSalary],
          ['실지취득단가', d.v.actualUnit],
          ['취득시 시가', d.v.fmvAtBuy],
          ['회사 무상출연(주)', d.v.compFreeShares],
          ['직원 출연(주)', d.v.employeeContribShares],
          ['인출 시 시가', d.v.fmvAtWithdraw],
          ['인출 회사무상(주)', d.v.withdrawCompFree],
          ['인출 직원출연(주)', d.v.withdrawEmployeeContrib],
          ['과세이연 한도 금액', d.deferralLimitAmt],
          ['매입가액(근로소득 기준단가)', d.buyBasis],
          ['한도 기준 주식 수', d.limitShares],
          ['한도 초과 주식 수', d.compOverLimit],
          ['한도 초과분 배정 시 과세표준(참고)', d.overlimitEarnedIncomeAtAllocation],
          ['과세인출주식 수', d.taxableWithdrawShares],
          ['과세 단가(원/주)', d.taxableUnit],
          ['인출 시 근로소득 합산 금액', d.earnedIncomeAtWithdraw],
          ['근로소득공제(근사)', d.eid],
          ['4대보험 근로자부담(근사)', d.si.total],
          ['기본공제', d.basicDeduction],
          ['과세표준(근사)', d.approxTaxableIncome],
          ['추정 한계세율(국세)', d.marginalRate],
          ['추정 한계세율(지방세 포함)', d.marginalRateWithLocal],
          ['예상 추가세금(근사)', d.estimatedAdditionalTax]
        ];
        const csv = rows.map(r => r.join(',')).join('\n');
        const blob = new Blob(["\ufeff" + csv], {type: 'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'esop_calc_result.csv';
        a.click();
      });

      // URL 파라미터 초기값
      const qs = new URLSearchParams(location.search);
      for (const id of allFieldIds){ if(qs.has(id)) $(id).value = fmt(toNumber(qs.get(id))); }
    }

    // init
    function init(){
      // 마스크 바인딩은 actions 전에 호출
      bindMasks();
      bindActions();
      render();
    }
    init();
  </script>
</body>
</html>
