<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>우리사주조합 과세이연·인출 과세액 계산기</title>
  <meta name="description" content="우리사주조합 과세이연 한도 및 인출 시 근로소득 과세액을 간편 계산합니다." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    input.num { text-align:right; font-variant-numeric: tabular-nums; }
    input.num::placeholder { color:#9ca3af; }
    input[disabled] { background-color:#f3f4f6 !important; color:#6b7280 !important; cursor:not-allowed; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
    <div class="mx-auto max-w-6xl px-5 py-3 flex items-center justify-between">
      <h1 class="text-lg font-bold">우리사주조합 과세이연·인출 과세액 계산기 <span class="text-xs align-top text-gray-500">(Beta)</span></h1>
      <a href="#how" class="text-sm text-gray-600 hover:text-gray-900">로직/주의사항</a>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-5 py-6">
    <section class="grid grid-cols-1 gap-6 md:grid-cols-2">
      <!-- 좌측: 입력 -->
      <div class="space-y-6">
        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h2 class="mb-3 text-lg font-semibold">① 기본 정보</h2>
          <div class="space-y-2">
            <label class="flex items-center justify-between gap-3">
              <span class="text-sm text-gray-700 whitespace-nowrap">직전연도 총급여액 (원) <span class="text-xs text-gray-500 whitespace-nowrap">(과세이연 한도 산정용)</span></span>
              <input id="prevYearSalary" type="text" class="num w-56 rounded-xl border px-3 py-2" placeholder="0" value="0" />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-sm text-gray-700">올해 예상 총급여액 (원) <span class="text-xs text-gray-500">(세율 시뮬레이션용)</span></span>
              <input id="currYearSalary" type="text" class="num w-56 rounded-xl border px-3 py-2" placeholder="0" value="0" />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-sm text-gray-700">근로소득 외 종합소득금액 (원) <span class="text-xs text-gray-500">(이자·배당·사업·기타 등)</span></span>
              <input id="otherIncome" type="text" class="num w-56 rounded-xl border px-3 py-2" placeholder="0" value="0" />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-sm text-gray-700">중소기업 여부</span>
              <input id="isSME" type="checkbox" class="h-5 w-5" />
            </label>
            <p class="text-xs text-gray-500 leading-5">※ 총급여액의 의미: 급여명세서의 <strong>총지급액</strong>을 말하며, <strong>당기에 지급받은 성과급</strong>도 포함합니다. (세율 시뮬레이션을 위한 근사치로 사용)</p>
          </div>
        </div>

        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h2 class="mb-3 text-lg font-semibold">② 이번연도 취득 단가 및 주식수</h2>
          <div class="space-y-2">
            <label class="flex items-center justify-between gap-3">
              <span class="text-sm text-gray-700 whitespace-nowrap leading-5">실지취득단가 (원/주)</span>
              <input id="actualUnit" type="text" class="num w-56 rounded-xl border px-3 py-2" placeholder="0" value="0" />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-sm text-gray-700 whitespace-nowrap leading-5">취득시 시가 (원/주)</span>
              <input id="fmvAtBuy" type="text" class="num w-56 rounded-xl border px-3 py-2" placeholder="0" value="0" />
            </label>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <label class="flex items-center justify-between gap-3">
                <span class="text-sm text-gray-700 whitespace-nowrap leading-5">회사 무상출연분 (주)</span>
                <input id="compFreeShares" type="text" class="num w-40 rounded-xl border px-3 py-2" placeholder="0" value="0" />
              </label>
              <label class="flex items-center justify-between gap-3">
                <span class="text-sm text-gray-700 whitespace-nowrap leading-5">직원 출연분 (주)</span>
                <input id="employeeContribShares" type="text" class="num w-40 rounded-xl border px-3 py-2" placeholder="0" value="0" />
              </label>
            </div>
          </div>
        </div>

        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h2 class="mb-3 text-lg font-semibold">③ 인출 정보</h2>
          <div class="space-y-2">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <label class="flex items-center justify-between gap-3">
                <span class="text-sm text-gray-700 whitespace-nowrap leading-5">인출대상 실지취득단가 (원/주)</span>
                <input id="withdrawActualUnit" type="text" class="num w-40 rounded-xl border px-3 py-2" placeholder="0" value="0" />
              </label>
              <label class="flex items-center justify-between gap-3">
                <span class="text-sm text-gray-700 whitespace-nowrap leading-5">인출 시 시가 (원/주)</span>
                <input id="fmvAtWithdraw" type="text" class="num w-40 rounded-xl border px-3 py-2" placeholder="0" value="0" />
              </label>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <label class="flex items-center justify-between gap-3">
                <span class="text-sm text-gray-700 whitespace-nowrap leading-5">인출할 회사 무상출연분 (주)</span>
                <input id="withdrawCompFree" type="text" class="num w-40 rounded-xl border px-3 py-2" placeholder="0" value="0" />
              </label>
              <label class="flex items-center justify-between gap-3">
                <span class="text-sm text-gray-700 whitespace-nowrap leading-5">인출할 직원 출연분 (주)</span>
                <input id="withdrawEmployeeContrib" type="text" class="num w-40 rounded-xl border px-3 py-2" placeholder="0" value="0" />
              </label>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 pt-1">
              <label class="flex items-center justify-between gap-3">
                <span class="text-sm text-gray-700">취득일자</span>
                <input id="acqDate" type="date" class="w-40 rounded-xl border px-3 py-2" />
              </label>
              <label class="flex items-center justify-between gap-3">
                <span class="text-sm text-gray-700">인출일자</span>
                <input id="wdDate" type="date" class="w-40 rounded-xl border px-3 py-2" />
              </label>
              <label class="flex items-center justify-between gap-3">
                <span class="text-sm text-gray-700">의무예탁기간(년)</span>
                <input id="escrowYears" type="text" class="num w-24 rounded-xl border px-3 py-2" value="1" />
              </label>
            </div>
            <p class="text-xs text-gray-500 leading-5">※ 회사 무상출연 물량의 의무예탁기간은 회사·조합과의 <strong>협의 기간</strong>에 따라 정해집니다. 일반적으로 1년 이상 설정하며, 종료 후 보유기간에 따라 비과세율이 적용될 수 있습니다.</p>
          </div>
        </div>

        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <div class="flex items-center justify-between">
            <h2 class="mb-3 text-lg font-semibold">④ 공제(근사) 설정</h2>
            <button id="toggleSI" class="rounded-lg border px-3 py-1.5 text-xs hover:bg-gray-50">4대보험율 편집</button>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
            <label class="flex items-center justify-between gap-3">
              <span class="text-gray-700">기본공제 인원(본인 포함)</span>
              <input id="basicDeductCount" type="text" class="num w-32 rounded-xl border px-3 py-2" value="1" />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-gray-700">국민연금율(근로자부담, %)</span>
              <input id="rateNP" type="text" class="num w-32 rounded-xl border px-3 py-2" value="4.5" disabled />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-gray-700">건강보험율(근로자부담, %)</span>
              <input id="rateHI" type="text" class="num w-32 rounded-xl border px-3 py-2" value="3.545" disabled />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-gray-700">장기요양(건보의 %, 근로자부담)</span>
              <input id="rateLTC" type="text" class="num w-32 rounded-xl border px-3 py-2" value="12.95" disabled />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-gray-700">고용보험율(근로자부담, %)</span>
              <input id="rateEI" type="text" class="num w-32 rounded-xl border px-3 py-2" value="0.9" disabled />
            </label>
            <label class="flex items-center justify-between gap-3 sm:col-span-2">
              <span class="text-gray-700">우리사주조합 출연 소득공제 (원, 일반 400만 / 벤처 1,500만 한도)</span>
              <input id="esopDeduct" type="text" class="num w-40 rounded-xl border px-3 py-2" value="4,000,000" />
            </label>
            <label class="flex items-center justify-between gap-3 sm:col-span-2">
              <span class="text-gray-700">기타 소득공제 (원, 신용카드 등)</span>
              <input id="otherDeductions" type="text" class="num w-40 rounded-xl border px-3 py-2" placeholder="0" value="0" />
            </label>
          </div>
          <p class="mt-2 text-xs text-gray-500">※ 위 비율은 <strong>추정치</strong>로, 실제 고시와 사업장 유형에 따라 달라질 수 있습니다. 필요 시 숫자를 조정하세요.<br>※ 우리사주조합 출연금은 일반기업 연 400만원, 벤처기업 연 1,500만원 한도 내에서 소득공제가 가능하며 과세표준 계산 시 차감됩니다.</p>
        </div>

        <div class="rounded-2xl border bg-white p-5 shadow-sm flex items-center justify-between gap-3">
          <button id="resetBtn" class="rounded-xl border px-4 py-2 text-sm hover:bg-gray-50">입력 초기화</button>
          <div class="space-x-2">
            <button id="copyUrlBtn" class="rounded-xl border px-4 py-2 text-sm hover:bg-gray-50">현재 입력 공유 링크 복사</button>
            <button id="downloadBtn" class="rounded-xl border px-4 py-2 text-sm hover:bg-gray-50">결과 CSV 다운로드</button>
          </div>
        </div>
      </div>

      <!-- 우측: 결과 -->
      <div class="space-y-6">
        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h2 class="mb-3 text-lg font-semibold">⑤ 결과 요약</h2>
          <div class="grid grid-cols-1 gap-3 sm:grid-cols-2" id="cardsA"></div>
        </div>

        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h3 class="mb-2 font-semibold">A. 회사 무상출연분 <span class="text-gray-500">한도초과 계산</span></h3>
          <div id="overlimitBox" class="text-sm text-gray-800"></div>
        </div>

        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h3 class="mb-2 font-semibold">B. 인출 시 근로소득 <span class="text-gray-500">합산 금액</span></h3>
          <div id="withdrawBox" class="text-sm text-gray-800"></div>
        </div>

        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h3 class="mb-2 font-semibold">C. 세율 구간 & 추가세금 시뮬레이션(근사)</h3>
          <div id="taxbox" class="text-sm text-gray-800"></div>
        </div>

        <div id="detail" class="rounded-2xl border bg-white p-5 shadow-sm text-sm leading-6 text-gray-800"></div>
      </div>
    </section>

    <section id="how" class="mt-8 rounded-2xl border bg-white p-5 shadow-sm">
      <h3 class="mb-2 text-base font-semibold">계산 로직(요지) & 주의사항</h3>
      <ul class="list-disc pl-5 text-sm text-gray-700 space-y-1">
        <li>과세이연 한도 금액 = <strong>max(직전연도 총급여액×20%, 5,000,000원)</strong></li>
        <li>매입가액(근로소득 기준단가) = <strong>max(실지취득단가, 취득시 시가×70%)</strong></li>
        <li>회사 무상출연분: 한도 내 물량은 <strong>인출 시 근로소득 과세</strong>, 한도 초과분은 <strong>배정 시 근로소득 과세</strong></li>
        <li>직원 출연분: 전량 <strong>인출 시 근로소득 과세</strong></li>
        <li>인출 시 근로소득 합산액 = (과세인출주식 수) × <strong>min(매입가액, 인출시 시가)</strong><br><span class="text-xs text-gray-500">※ 인출대상 주식의 실지취득단가를 반영하여 매입가액을 산출합니다.</span></li>
        <li>비과세율(의무예탁 종료 후 보유기간 기준): <strong>2~4년 미만 50%</strong>, <strong>4년 이상 75%</strong>, <strong>6년 이상 100%</strong>(<strong>중소기업만</strong>)</li>
        <li>세율 시뮬레이션은 <strong>근로소득공제·기본공제·4대보험(전기 총급여 기준 추정)</strong> 및 <strong>우리사주/기타 소득공제</strong>를 반영한 <strong>과세표준 근사치</strong>를 이용합니다.</li>
      </ul>
      <p class="mt-3 text-xs text-gray-500">※ 실제 신고 시에는 공제항목·세액공제·연금보험료 한도·급여 외 소득 합산 등에 따라 결과가 달라질 수 있습니다. 본 계산기는 <strong>참고용</strong>입니다.</p>
    </section>
  </main>

  <footer class="mt-10 border-t">
    <div class="mx-auto max-w-6xl px-5 py-6 text-xs text-gray-500">© 2025 우리사주 간이 계산기 (Beta). 모든 책임은 사용자에게 있으며, 본 도구는 참고용입니다.</div>
  </footer>

  <script>
    const $ = (id) => document.getElementById(id);
    const toNumber = (str) => {
      const cleaned = String(str||'').replace(/[^0-9.-]/g,'');
      const n = parseFloat(cleaned);
      return Number.isFinite(n) ? n : 0;
    };
    const fmt = (n) => Number.isFinite(n) ? n.toLocaleString('ko-KR') : '';

    // 입력 필드 목록 (콤마 마스크 적용 대상)
    const allFieldIds = [
      'prevYearSalary','currYearSalary','otherIncome','actualUnit','fmvAtBuy','compFreeShares','employeeContribShares','fmvAtWithdraw','withdrawCompFree','withdrawEmployeeContrib','basicDeductCount','rateNP','rateHI','rateLTC','rateEI','esopDeduct','otherDeductions','withdrawActualUnit','escrowYears'
    ];

    function bindMasks(){
      for (const id of allFieldIds){
        const el = $(id);
        if(!el) continue;
        const handler = () => { el.value = fmt(toNumber(el.value)); render(); };
        el.addEventListener('input', handler);
        el.value = fmt(toNumber(el.value));
      }
    }

    function read(){
      const v = {};
      for (const id of allFieldIds) v[id] = toNumber($(id)?.value || 0);
      // 정수화 필요한 항목들(주식 수/인원)
      v.compFreeShares = Math.max(0, Math.floor(v.compFreeShares));
      v.employeeContribShares = Math.max(0, Math.floor(v.employeeContribShares));
      v.withdrawCompFree = Math.max(0, Math.floor(v.withdrawCompFree));
      v.withdrawEmployeeContrib = Math.max(0, Math.floor(v.withdrawEmployeeContrib));
      v.basicDeductCount = Math.max(0, Math.floor(v.basicDeductCount));
      v.isSME = !!$('isSME')?.checked;
      v.acqDate = $('acqDate')?.value || '';
      v.wdDate  = $('wdDate')?.value  || '';
      return v;
    }

    // 근로소득공제(간편 근사식)
    function earnedIncomeDeduction(gross){
      const x = Math.max(0, gross);
      if (x <= 12000000) return x*0.7;
      if (x <= 46000000) return 3600000 + (x-12000000)*0.4;
      if (x <= 88000000) return 7500000 + (x-46000000)*0.15;
      if (x <= 150000000) return 13500000 + (x-88000000)*0.05;
      return 16000000 + (x-150000000)*0.02;
    }

    // 4대보험(근로자부담) 추정: 전기 총급여 기준
    function socialInsurance(prevGross, rateNP, rateHI, rateLTC, rateEI){
      const np = prevGross * (rateNP/100);
      const hi = prevGross * (rateHI/100);
      const ltc = hi * (rateLTC/100);
      const ei = prevGross * (rateEI/100);
      return { np, hi, ltc, ei, total: np+hi+ltc+ei };
    }

    function yearsBetween(aStr, bStr){
      if(!aStr || !bStr) return 0;
      const a = new Date(aStr);
      const b = new Date(bStr);
      if (isNaN(a) || isNaN(b)) return 0;
      const ms = b - a;
      return Math.max(0, ms / (1000*60*60*24*365.25));
    }

    function compute(){
      const v = read();

      // 1) 과세이연 한도, 매입가액(일반), 한도 주식 수
      const deferralLimitAmt = Math.max(v.prevYearSalary * 0.20, 5000000);
      const buyBasisGeneral = Math.max(v.actualUnit, Math.floor(v.fmvAtBuy * 0.7));
      const limitShares = buyBasisGeneral > 0 ? Math.floor(deferralLimitAmt / buyBasisGeneral) : 0;

      const compWithinLimit = Math.min(v.compFreeShares, limitShares);
      const compOverLimit   = Math.max(v.compFreeShares - compWithinLimit, 0);
      const overlimitEarnedIncomeAtAllocation = compOverLimit * buyBasisGeneral; // 배정시 과세 참고치

      // 2) 인출 과세 단가: 인출대상 실지취득단가 반영
      const buyBasisForWithdraw = Math.max(v.withdrawActualUnit, Math.floor(v.fmvAtBuy * 0.7));
      const taxableUnit = Math.min(buyBasisForWithdraw, v.fmvAtWithdraw);

      const taxableWithdrawFromComp = Math.min(v.withdrawCompFree, compWithinLimit);
      const taxableWithdrawFromEmployee = Math.min(v.withdrawEmployeeContrib, v.employeeContribShares);
      const taxableWithdrawShares = taxableWithdrawFromComp + taxableWithdrawFromEmployee;

      // 3) 보유기간·비과세율
      const totalYears = yearsBetween(v.acqDate, v.wdDate);
      const afterEscrowYears = Math.max(0, totalYears - (v.escrowYears || 0));
      let exemptRate = 0;
      if (afterEscrowYears >= 6 && v.isSME) exemptRate = 1.0;
      else if (afterEscrowYears >= 4) exemptRate = 0.75;
      else if (afterEscrowYears >= 2) exemptRate = 0.50;

      const earnedIncomeAtWithdrawGross = taxableWithdrawShares * taxableUnit;
      const exemptAmount = Math.round(earnedIncomeAtWithdrawGross * exemptRate);
      const earnedIncomeAtWithdraw = Math.max(0, earnedIncomeAtWithdrawGross - exemptAmount);

      // 4) 과세표준 근사 및 세율: 전기 총급여로 4대보험 추정, 기타/ESOP 소득공제 차감
      const eid = earnedIncomeDeduction(v.currYearSalary);
      const si = socialInsurance(v.prevYearSalary, v.rateNP, v.rateHI, v.rateLTC, v.rateEI);
      const basicDeduction = v.basicDeductCount * 1500000; // 1인 150만원 가정
      const earnedBase = Math.max(0, v.currYearSalary - eid - si.total);
      const approxTaxableIncome = Math.max(0, earnedBase + v.otherIncome - basicDeduction - v.esopDeduct - v.otherDeductions);

      const brackets = [
        { upTo: 12000000, rate: 0.06 },
        { upTo: 46000000, rate: 0.15 },
        { upTo: 88000000, rate: 0.24 },
        { upTo: 150000000, rate: 0.35 },
        { upTo: 300000000, rate: 0.38 },
        { upTo: 500000000, rate: 0.40 },
        { upTo: 1000000000, rate: 0.42 },
        { upTo: Infinity, rate: 0.45 },
      ];
      const marginalRate = (() => {
        for (const b of brackets){ if (approxTaxableIncome <= b.upTo) return b.rate; }
        return brackets[brackets.length-1].rate;
      })();
      const marginalRateWithLocal = marginalRate * 1.10; // 지방세 10%
      const estimatedAdditionalTax = Math.round(earnedIncomeAtWithdraw * marginalRateWithLocal);

      return {
        v,
        deferralLimitAmt, buyBasisGeneral, buyBasisForWithdraw, limitShares,
        compWithinLimit, compOverLimit, overlimitEarnedIncomeAtAllocation,
        taxableWithdrawFromComp, taxableWithdrawFromEmployee, taxableWithdrawShares,
        taxableUnit, earnedIncomeAtWithdrawGross, exemptRate, exemptAmount, earnedIncomeAtWithdraw,
        eid, si, basicDeduction, approxTaxableIncome,
        brackets, marginalRate, marginalRateWithLocal, estimatedAdditionalTax,
        totalYears, afterEscrowYears
      };
    }

    function render(){
      const d = compute();

      // 요약 카드
      const cards = [
        {title:'과세이연 한도 금액', value:d.deferralLimitAmt, unit:'원', desc:'max(직전연도 총급여×20%, 5,000,000)'},
        {title:'매입가액(근로소득 기준단가, 일반)', value:d.buyBasisGeneral, unit:'원/주', desc:'max(실지취득단가, 시가×70%)'},
        {title:'한도 기준 주식 수', value:d.limitShares, unit:'주', desc:'과세이연 한도금액 ÷ 매입가액'},
        {title:'인출 시 과세 단가', value:d.taxableUnit, unit:'원/주', desc:'min(인출대상 매입가액, 인출시 시가)'}
      ];
      $('cardsA').innerHTML = cards.map(c => `
        <div class="rounded-2xl border p-4 shadow-sm">
          <div class="text-xs text-gray-500">${c.title}</div>
          <div class="mt-1 text-2xl font-semibold">${fmt(c.value)}<span class="ml-1 text-base font-normal text-gray-500">${c.unit}</span></div>
          <div class="mt-1 text-xs text-gray-500">${c.desc}</div>
        </div>`).join('');

      // A. 한도초과 계산
      $('overlimitBox').innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="rounded-xl bg-gray-50 p-3">
            <div class="text-xs text-gray-500">회사 무상출연분(전체)</div>
            <div class="text-lg font-semibold">${fmt(d.v.compFreeShares)} <span class="text-sm">주</span></div>
          </div>
          <div class="rounded-xl bg-gray-50 p-3">
            <div class="text-xs text-gray-500">회사 무상 한도 내 주식 수</div>
            <div class="text-lg font-semibold">${fmt(d.compWithinLimit)} <span class="text-sm">주</span></div>
          </div>
          <div class="rounded-xl bg-gray-50 p-3">
            <div class="text-xs text-gray-500">회사 무상 한도 초과 주식 수</div>
            <div class="text-lg font-semibold">${fmt(d.compOverLimit)} <span class="text-sm">주</span></div>
          </div>
          <div class="rounded-xl bg-gray-50 p-3">
            <div class="text-xs text-gray-500">한도 초과분 배정 시 과세표준(참고)</div>
            <div class="text-lg font-semibold">${fmt(d.overlimitEarnedIncomeAtAllocation)} <span class="text-sm">원</span></div>
            <div class="mt-1 text-xs text-gray-500">= 한도 초과 주식 수 × 매입가액(근로소득 기준단가)</div>
          </div>
        </div>`;

      // B. 인출 합산 금액 + 비과세율
      const exemptPctTxt = `${Math.round(d.exemptRate*100)}%`;
      $('withdrawBox').innerHTML = `
        <div class="grid grid-cols-1 gap-3">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="rounded-xl bg-gray-50 p-3">
              <div class="text-xs text-gray-500">이번 인출의 과세인출주식 수</div>
              <div class="text-lg font-semibold">${fmt(d.taxableWithdrawShares)} <span class="text-sm">주</span></div>
              <div class="mt-1 text-xs text-gray-500">회사(한도내) ${fmt(d.taxableWithdrawFromComp)}주 + 직원출연 ${fmt(d.taxableWithdrawFromEmployee)}주</div>
            </div>
            <div class="rounded-xl bg-gray-50 p-3">
              <div class="text-xs text-gray-500">인출 시 과세단가(원/주)</div>
              <div class="text-lg font-semibold">${fmt(d.taxableUnit)} <span class="text-sm">원/주</span></div>
              <div class="mt-1 text-xs text-gray-500">= min(인출대상 매입가액, 인출시 시가)</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="rounded-xl bg-gray-50 p-3">
              <div class="text-xs text-gray-500">보유기간(의무예탁 제외)</div>
              <div class="text-lg font-semibold">${d.afterEscrowYears.toFixed(2)} <span class="text-sm">년</span></div>
              <div class="mt-1 text-xs text-gray-500">총 ${d.totalYears.toFixed(2)}년 · 의무예탁 ${d.v.escrowYears || 0}년</div>
            </div>
            <div class="rounded-xl bg-gray-50 p-3">
              <div class="text-xs text-gray-500">적용 비과세율</div>
              <div class="text-lg font-semibold">${exemptPctTxt}</div>
              <div class="mt-1 text-xs text-gray-500">(6년 100%는 중소기업만)</div>
            </div>
            <div class="rounded-xl bg-gray-50 p-3">
              <div class="text-xs text-gray-500">비과세 금액</div>
              <div class="text-lg font-semibold">${fmt(d.exemptAmount)} <span class="text-sm">원</span></div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="rounded-xl bg-gray-50 p-3">
              <div class="text-xs text-gray-500">인출 시 근로소득 합산 금액(비과세 적용 전)</div>
              <div class="text-lg font-semibold">${fmt(d.earnedIncomeAtWithdrawGross)} <span class="text-sm">원</span></div>
            </div>
            <div class="rounded-xl bg-gray-50 p-3">
              <div class="text-xs text-gray-500">인출 시 근로소득 합산 금액(비과세 적용 후)</div>
              <div class="text-lg font-semibold">${fmt(d.earnedIncomeAtWithdraw)} <span class="text-sm">원</span></div>
            </div>
          </div>
        </div>`;

      // C. 세율 구간 및 추가세금 시뮬레이션
      const taxRows = d.brackets.map((b, i) => {
        const from = i === 0 ? 0 : d.brackets[i-1].upTo + 1;
        const to   = b.upTo === Infinity ? '이상' : `${fmt(b.upTo)}원`;
        const isMy = (d.approxTaxableIncome <= b.upTo);
        return `<tr class="${isMy ? 'bg-gray-50' : ''}">
          <td class="px-3 py-1 text-right whitespace-nowrap">${fmt(from)}원 ~ ${to}</td>
          <td class="px-3 py-1 text-right">${Math.round(b.rate*100)}%</td>
          <td class="px-3 py-1 text-right">${Math.round(b.rate*11000)/100}% (지방세 포함)</td>
        </tr>`;
      }).join('');

      $('taxbox').innerHTML = `
        <div class="grid grid-cols-1 gap-3">
          <div class="rounded-xl bg-gray-50 p-3 text-sm">
            <div class="grid grid-cols-2 gap-2">
              <div>근로소득공제(근사)</div><div class="text-right font-semibold">${fmt(d.eid)} 원</div>
              <div>4대보험(근로자부담·근사, 전기 기준)</div><div class="text-right font-semibold">${fmt(d.si.total)} 원 <span class="text-xs text-gray-500">(국민:${fmt(d.si.np)}, 건보:${fmt(d.si.hi)}, 장기요양:${fmt(d.si.ltc)}, 고용:${fmt(d.si.ei)})</span></div>
              <div>기본공제(본인 등)</div><div class="text-right font-semibold">${fmt(d.basicDeduction)} 원</div>
              <div>우리사주 출연 소득공제</div><div class="text-right font-semibold">${fmt(d.v.esopDeduct)} 원</div>
              <div>기타 소득공제</div><div class="text-right font-semibold">${fmt(d.v.otherDeductions)} 원</div>
              <div>과세표준(근사)</div><div class="text-right font-semibold">${fmt(d.approxTaxableIncome)} 원</div>
            </div>
          </div>
          <div class="overflow-auto">
            <table class="w-full text-xs">
              <thead class="text-gray-500">
                <tr>
                  <th class="px-3 py-1 text-right font-medium">과세표준 구간(근사)</th>
                  <th class="px-3 py-1 text-right font-medium">국세 세율</th>
                  <th class="px-3 py-1 text-right font-medium">합산 세율(국세+지방세)</th>
                </tr>
              </thead>
              <tbody>${taxRows}</tbody>
            </table>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="rounded-xl bg-gray-50 p-3">
              <div class="text-xs text-gray-500">추정 한계세율(국세)</div>
              <div class="text-lg font-semibold">${Math.round(d.marginalRate*100)}%</div>
            </div>
            <div class="rounded-xl bg-gray-50 p-3">
              <div class="text-xs text-gray-500">추정 한계세율(지방세 포함)</div>
              <div class="text-lg font-semibold">${Math.round(d.marginalRateWithLocal*10000)/100}%</div>
            </div>
            <div class="rounded-xl bg-gray-50 p-3">
              <div class="text-xs text-gray-500">예상 추가세금(근사)</div>
              <div class="text-lg font-semibold">${fmt(d.estimatedAdditionalTax)} 원</div>
              <div class="mt-1 text-xs text-gray-500">(비과세 적용 후 합산금액 기준)</div>
            </div>
          </div>
          <div class="text-xs text-gray-500">※ 추가세금은 <strong>B. 인출 시 근로소득 합산 금액(비과세 적용 후)</strong>에 추정 한계세율(지방세 포함)을 적용한 값(근사)입니다.</div>
        </div>`;

      // 하단 디테일 박스
      $('detail').innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="rounded-xl bg-gray-50 p-3">
            <div class="text-xs text-gray-500">매입가액(근로소득 기준단가, 일반)</div>
            <div class="text-lg font-semibold">${fmt(d.buyBasisGeneral)} <span class="text-sm">원/주</span></div>
            <div class="mt-1 text-xs text-gray-500">= max(실지취득단가, 취득시 시가×70%)</div>
          </div>
          <div class="rounded-xl bg-gray-50 p-3">
            <div class="text-xs text-gray-500">인출대상 매입가액</div>
            <div class="text-lg font-semibold">${fmt(d.buyBasisForWithdraw)} <span class="text-sm">원/주</span></div>
            <div class="mt-1 text-xs text-gray-500">= max(인출대상 실지취득단가, 취득시 시가×70%)</div>
          </div>
        </div>
        <div class="mt-3 text-xs text-gray-500">※ 본 계산기는 참고용이며, 실제 신고는 회사 규정 및 세무전문가 확인이 필요합니다.</div>
      `;
    }

    function bindActions(){
      // 4대보험율 편집 토글
      $('toggleSI').addEventListener('click', () => {
        ['rateNP','rateHI','rateLTC','rateEI'].forEach(id => {
          const el = $(id);
          el.disabled = !el.disabled;
        });
      });

      $('resetBtn').addEventListener('click', () => {
        const defaults = {
          prevYearSalary:'0', currYearSalary:'0', otherIncome:'0', actualUnit:'0', fmvAtBuy:'0',
          compFreeShares:'0', employeeContribShares:'0', fmvAtWithdraw:'0', withdrawCompFree:'0', withdrawEmployeeContrib:'0',
          basicDeductCount:'1', rateNP:'4.5', rateHI:'3.545', rateLTC:'12.95', rateEI:'0.9',
          esopDeduct:'4,000,000', otherDeductions:'0', withdrawActualUnit:'0', escrowYears:'1'
        };
        for (const id of Object.keys(defaults)) $(id).value = defaults[id];
        $('isSME').checked = false;
        $('acqDate').value = '';
        $('wdDate').value  = '';
        bindMasks();
        render();
      });

      $('copyUrlBtn').addEventListener('click', () => {
        const params = new URLSearchParams();
        for (const id of allFieldIds) params.set(id, toNumber($(id).value));
        params.set('isSME', $('isSME').checked ? '1':'0');
        params.set('acqDate', $('acqDate').value||'');
        params.set('wdDate', $('wdDate').value||'');
        const url = `${location.origin}${location.pathname}?${params.toString()}`;
        navigator.clipboard.writeText(url).then(() => alert('현재 입력이 포함된 링크를 복사했습니다.'));
      });

      $('downloadBtn').addEventListener('click', () => {
        const d = compute();
        const rows = [
          ['항목','값'],
          ['직전연도 총급여액', d.v.prevYearSalary],
          ['올해 예상 총급여액', d.v.currYearSalary],
          ['근로소득 외 종합소득금액', d.v.otherIncome],
          ['중소기업 여부', d.v.isSME ? 'Y':'N'],
          ['실지취득단가(일반)', d.v.actualUnit],
          ['취득시 시가', d.v.fmvAtBuy],
          ['회사 무상출연(주)', d.v.compFreeShares],
          ['직원 출연(주)', d.v.employeeContribShares],
          ['인출대상 실지취득단가', d.v.withdrawActualUnit],
          ['인출 시 시가', d.v.fmvAtWithdraw],
          ['인출 회사무상(주)', d.v.withdrawCompFree],
          ['인출 직원출연(주)', d.v.withdrawEmployeeContrib],
          ['취득일자', $('acqDate').value],
          ['인출일자', $('wdDate').value],
          ['의무예탁기간(년)', d.v.escrowYears],
          ['과세이연 한도 금액', d.deferralLimitAmt],
          ['매입가액(일반)', d.buyBasisGeneral],
          ['인출대상 매입가액', d.buyBasisForWithdraw],
          ['한도 기준 주식 수', d.limitShares],
          ['한도 초과 주식 수', d.compOverLimit],
          ['한도 초과분 배정 시 과세표준(참고)', d.overlimitEarnedIncomeAtAllocation],
          ['과세인출주식 수', d.taxableWithdrawShares],
          ['인출 시 근로소득 합산(전)', d.earnedIncomeAtWithdrawGross],
          ['적용 비과세율', d.exemptRate],
          ['비과세 금액', d.exemptAmount],
          ['인출 시 근로소득 합산(후)', d.earnedIncomeAtWithdraw],
          ['근로소득공제(근사)', d.eid],
          ['4대보험 근로자부담(전기 기준·근사)', d.si.total],
          ['기본공제', d.basicDeduction],
          ['우리사주 출연 소득공제', d.v.esopDeduct],
          ['기타 소득공제', d.v.otherDeductions],
          ['과세표준(근사)', d.approxTaxableIncome],
          ['추정 한계세율(국세)', d.marginalRate],
          ['추정 한계세율(지방세 포함)', d.marginalRateWithLocal],
          ['예상 추가세금(근사)', d.estimatedAdditionalTax]
        ];
        const csv = rows.map(r => r.join(',')).join('\n');
        const blob = new Blob(["\ufeff" + csv], {type: 'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'esop_calc_result.csv';
        a.click();
      });

      // URL 파라미터 초기값
      const qs = new URLSearchParams(location.search);
      for (const id of allFieldIds){ if(qs.has(id)) $(id).value = fmt(toNumber(qs.get(id))); }
      if (qs.has('isSME')) $('isSME').checked = (qs.get('isSME') === '1');
      if (qs.has('acqDate')) $('acqDate').value = qs.get('acqDate');
      if (qs.has('wdDate'))  $('wdDate').value  = qs.get('wdDate');
    }

    // init
    bindMasks();
    bindActions();
    render();
  </script>
</body>
</html>
